#!/usr/bin/env bash

set -e  # Exit on error
set -u  # Error on unset variables

COMMAND=$1
shift || true  # remove command from args

case "$COMMAND" in
    init)
    echo "âš™ï¸  Initializing development environment..."
    # Create venv with uv if it doesn't exist
    if [ ! -d ".venv" ]; then
      uv venv
    fi
    source .venv/bin/activate

    # Install project dependencies (idempotent)
    uv pip install -e .

    # Install pre-commit hooks and type stubs
    uv run pre-commit install
    uv run mypy --install-types 

    ;;
  format)
    echo "ğŸ§¼ Formatting code with ruff..."
    uv run ruff check . --fix
    ;;
  
  lint)
    echo "ğŸ” Linting with Ruff..."
    uv run ruff check .
    ;;

  test)
    echo "ğŸ§ª Running tests..."
    uv run pytest tests/
    ;;

  typecheck)
    echo "ğŸ” Running mypy type check..."
    uv run mypy scripts/
    ;;

  coverage)
    echo "ğŸ“Š Running test coverage..."
    uv run coverage run -m pytest
    uv run coverage report
    ;;

  all)
    echo "ğŸš€ Running all checks (format â†’ lint â†’ typecheck â†’ test)..."
    ./tasks format
    ./tasks lint
    ./tasks typecheck
    ./tasks test
    ;;

  pre-commit)
    echo "ğŸ”§ Running pre-commit hooks on all files..."
    ./tasks format
    ./tasks lint
    ./tasks typecheck
    ;;

  *)
    echo "âŒ Unknown command: $COMMAND"
    echo "Usage: ./tasks [format|lint|test|typecheck|coverage|all]"
    exit 1
    ;;
esac
